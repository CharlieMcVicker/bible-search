{% extends "base.html" %} {% block title %}Search Results - Cherokee Search{%
endblock %} {% block content %}
<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0">Results for "{{ query }}"</h2>
      <!-- Refinement Form -->
      <form
        action="{{ url_for('search_page') }}"
        method="GET"
        class="d-flex align-items-center gap-2"
      >
        <input type="hidden" name="q" value="{{ query }}" />

        <div class="form-check form-switch mb-0">
          <input
            class="form-check-input"
            type="checkbox"
            id="useLemmaRefine"
            name="use_lemma"
            {%
            if
            use_lemma
            %}checked{%
            endif
            %}
            onchange="this.form.submit()"
          />
          <label class="form-check-label text-nowrap" for="useLemmaRefine"
            >Roots</label
          >
        </div>

        <div class="form-check form-switch mb-0">
          <input
            class="form-check-input"
            type="checkbox"
            id="isHypotheticalRefine"
            name="is_hypothetical"
            {%
            if
            is_hypothetical
            %}checked{%
            endif
            %}
            onchange="this.form.submit()"
          />
          <label class="form-check-label text-nowrap" for="isHypotheticalRefine"
            >Hypothetical</label
          >
        </div>

        <div class="form-check form-switch mb-0">
          <input
            class="form-check-input"
            type="checkbox"
            id="isCommandRefine"
            name="is_command"
            {%
            if
            is_command
            %}checked{%
            endif
            %}
            onchange="this.form.submit()"
          />
          <label class="form-check-label text-nowrap" for="isCommandRefine"
            >Imperative</label
          >
        </div>

        <div class="form-check form-switch mb-0">
          <input
            class="form-check-input"
            type="checkbox"
            id="isTimeClauseRefine"
            name="is_time_clause"
            {%
            if
            is_time_clause
            %}checked{%
            endif
            %}
            onchange="this.form.submit()"
          />
          <label class="form-check-label text-nowrap" for="isTimeClauseRefine"
            >Time Clauses</label
          >
        </div>

        <div class="input-group input-group-sm me-2" style="max-width: 150px">
          <span class="input-group-text">Tag</span>
          <select class="form-select" name="tag" onchange="this.form.submit()">
            <option value="">Any</option>
            <option value="converb" {{ 'selected' if tag_filter == 'converb' else '' }}>converb</option>
            <option value="yi+converb" {{ 'selected' if tag_filter == 'yi+converb' else '' }}>yi+converb</option>
            <option value="incompletive deverbal" {{ 'selected' if tag_filter == 'incompletive deverbal' else '' }}>incompletive deverbal</option>
          </select>
        </div>

        <div class="input-group input-group-sm me-2">
          <span class="input-group-text">Sort</span>
          <select class="form-select" name="sort" onchange="this.form.submit()">
            <option value="rank" {{ 'selected' if sort == 'rank' else '' }}>Relevance</option>
            <option value="length_asc" {{ 'selected' if sort == 'length_asc' else '' }}>Shortest</option>
            <option value="length_desc" {{ 'selected' if sort == 'length_desc' else '' }}>Longest</option>
          </select>
        </div>

        <div class="dropdown me-2">
          <button
            class="btn btn-sm btn-outline-secondary dropdown-toggle"
            type="button"
            id="subclauseDropdown"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            Subclauses {% if selected_subclauses %}
            <span class="badge bg-primary"
              >{{ selected_subclauses|length }}</span
            >
            {% endif %}
          </button>
          <div
            class="dropdown-menu p-3"
            aria-labelledby="subclauseDropdown"
            style="min-width: 250px"
          >
            {% for dep, label in subclause_labels.items() %}
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                name="subclause_types"
                value="{{ dep }}"
                id="sub_{{ dep }}"
                {%
                if
                dep
                in
                selected_subclauses
                %}checked{%
                endif
                %}
                onchange="this.form.submit()"
              />
              <label class="form-check-label" for="sub_{{ dep }}">
                {{ label }}
              </label>
            </div>
            {% endfor %} {% if selected_subclauses %}
            <hr class="dropdown-divider" />
            <a
              href="{{ url_for('search_page', q=query, use_lemma='on' if use_lemma else None, sort=sort, is_hypothetical='on' if is_hypothetical else None, is_command='on' if is_command else None) }}"
              class="btn btn-sm btn-link text-danger p-0"
              >Clear Subclauses</a
            >
            {% endif %}
          </div>
        </div>

        <button class="btn btn-sm btn-primary" type="submit">
          Apply
        </button>
      </form>
    </div>

    {% if sentences %}
    <p class="text-muted">
      Found {{ count }} result(s) on page {{ page }}. {% if use_lemma %}<span
        class="badge bg-info text-dark"
        >Lemma Search</span
      >{% endif %}
    </p>

    <div class="d-flex justify-content-end mb-2">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="tagModeToggle">
        <label class="form-check-label" for="tagModeToggle">Enable Tagging Mode</label>
      </div>
    </div>

    <div class="list-group mb-4">
      {% for sentence in sentences %}
      <div class="list-group-item list-group-item-action">
        <div class="d-flex w-100 justify-content-between">
          <h5 class="mb-1 cherokee-text" data-ref-id="{{ sentence.ref_id }}">
            {% set words = sentence.syllabary.split(' ') %}
            {% for word in words %}
              {% set ns = namespace(found_tag=None) %}
              {% if sentence.tags %}
                {% for t in sentence.tags %}
                  {% if t.word_index == loop.index0 %}
                    {% set ns.found_tag = t.tag %}
                  {% endif %}
                {% endfor %}
              {% endif %}
              <span class="word-token position-relative" data-index="{{ loop.index0 }}"
                    {% if ns.found_tag %}data-tag="{{ ns.found_tag }}" title="{{ ns.found_tag }}"{% endif %}>
                {{ word }}
                {% if ns.found_tag %}
                  <span class="position-absolute top-0 start-100 translate-middle p-1 bg-info border border-light rounded-circle" style="width: 10px; height: 10px;">
                    <span class="visually-hidden">Tagged</span>
                  </span>
                {% endif %}
              </span>
            {% endfor %}
          </h5>
          <small class="text-muted">{{ sentence.ref_id }}</small>
        </div>

        <div class="row">
          <div class="col-md-6 border-end">
            <p class="mb-1 fw-bold">{{ sentence.phonetic }}</p>
            <p class="mb-1">{{ sentence.english }}</p>
            {% if sentence.subclause_types %}
            <div class="mt-2">
              {% for stype in sentence.subclause_types.split(',') %}
              <span class="badge bg-light text-dark border">{{ subclause_labels.get(stype, stype) }}</span>
              {% endfor %}
            </div>
            {% endif %}
          </div>
          <div class="col-md-6 ps-4 d-flex align-items-center">
            {% if sentence.audio %}
            <audio
              controls
              src="{{ url_for('static', filename='audio/' + sentence.audio) }}"
            ></audio>
            {% else %}
            <span class="text-muted fst-italic">No audio</span>
            {% endif %}
          </div>
        </div>

        {% if sentence.lemma_text and use_lemma %}
        <small class="text-muted">Lemma: {{ sentence.lemma_text }}</small>
        {% endif %}
      </div>
      {% endfor %}
    </div>

    <!-- Pagination -->
    <nav aria-label="Search results pages">
      <ul class="pagination justify-content-center">
        {% if page > 1 %}
        <li class="page-item">
          <a
            class="page-link"
            href="{{ url_for('search_page', q=query, page=page-1, use_lemma='on' if use_lemma else None, sort=sort, is_hypothetical='on' if is_hypothetical else None, is_command='on' if is_command else None, subclause_types=selected_subclauses) }}"
            >Previous</a
          >
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">Previous</span>
        </li>
        {% endif %}

        <li class="page-item active" aria-current="page">
          <span class="page-link">{{ page }}</span>
        </li>

        {% if sentences|length == per_page %}
        <li class="page-item">
          <a
            class="page-link"
            href="{{ url_for('search_page', q=query, page=page+1, use_lemma='on' if use_lemma else None, sort=sort, is_hypothetical='on' if is_hypothetical else None, is_command='on' if is_command else None, subclause_types=selected_subclauses) }}"
            >Next</a
          >
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">Next</span>
        </li>
        {% endif %}
      </ul>
    </nav>

    {% else %}
    <div class="alert alert-info">No results found for "{{ query }}".</div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const tagModeToggle = document.getElementById('tagModeToggle');
    const tokenSpans = document.querySelectorAll('.word-token');

    // Tag options
    const TAG_OPTIONS = ["converb", "yi+converb", "incompletive deverbal"];

    // State
    let taggingEnabled = false;

    tagModeToggle.addEventListener('change', function() {
      taggingEnabled = this.checked;
      document.body.classList.toggle('tagging-mode-active', taggingEnabled);
    });

    tokenSpans.forEach(span => {
      span.addEventListener('click', function(e) {
        if (!taggingEnabled) return;
        e.preventDefault();
        e.stopPropagation();

        const refId = this.closest('.cherokee-text').dataset.refId;
        const index = parseInt(this.dataset.index);
        const currentTag = this.dataset.tag;

        // Simple prompt for now. Ideally a nice popover.
        let promptMsg = `Select tag for word:\n1. converb\n2. yi+converb\n3. incompletive deverbal\n\n(Enter number or name. Empty to clear)`;
        if (currentTag) promptMsg += `\nCurrent tag: ${currentTag}`;

        const input = prompt(promptMsg);

        if (input === null) return; // Cancelled

        let selectedTag = null;
        const normalizedInput = input.trim().toLowerCase();

        if (normalizedInput === "1" || normalizedInput === "converb") selectedTag = "converb";
        else if (normalizedInput === "2" || normalizedInput === "yi+converb") selectedTag = "yi+converb";
        else if (normalizedInput === "3" || normalizedInput === "incompletive deverbal") selectedTag = "incompletive deverbal";
        else if (normalizedInput === "") selectedTag = null; // Clear
        else if (normalizedInput !== "") {
          alert("Invalid tag selected.");
          return;
        }

        // Optimistic UI update
        const badge = this.querySelector('.bg-info');

        if (selectedTag) {
           // Add/Update tag
           fetch(`/api/sentences/${refId}/tags`, {
             method: 'POST',
             headers: {'Content-Type': 'application/json'},
             body: JSON.stringify({word_index: index, tag: selectedTag})
           }).then(res => res.json()).then(data => {
             if (data.status === 'success') {
                this.dataset.tag = selectedTag;
                this.title = selectedTag;
                if (!badge) {
                    const newBadge = document.createElement('span');
                    newBadge.className = "position-absolute top-0 start-100 translate-middle p-1 bg-info border border-light rounded-circle";
                    newBadge.style.width = "10px";
                    newBadge.style.height = "10px";
                    newBadge.innerHTML = '<span class="visually-hidden">Tagged</span>';
                    this.appendChild(newBadge);
                }
             } else {
               alert("Error saving tag: " + data.message);
             }
           });
        } else {
           // Remove tag
           if (currentTag) {
               fetch(`/api/sentences/${refId}/tags`, {
                 method: 'DELETE',
                 headers: {'Content-Type': 'application/json'},
                 body: JSON.stringify({word_index: index})
               }).then(res => res.json()).then(data => {
                 if (data.status === 'success') {
                    delete this.dataset.tag;
                    this.removeAttribute('title');
                    if (badge) badge.remove();
                 } else {
                   alert("Error removing tag: " + data.message);
                 }
               });
           }
        }

      });
    });
  });
</script>

<style>
  .tagging-mode-active .word-token {
    cursor: pointer;
    border-radius: 3px;
    padding: 0 2px;
  }
  .tagging-mode-active .word-token:hover {
    background-color: rgba(0, 123, 255, 0.1);
    outline: 1px dashed #007bff;
  }
</style>
{% endblock %}
